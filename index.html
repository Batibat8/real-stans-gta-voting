<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE REAL STANS OF GTA - Vote for Most Valuable Stan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDocs, increment } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyApWRRgZwFmfbIDVU-uhC73cyMDnNQ3jpY",
            authDomain: "rsogta-699a1.firebaseapp.com",
            projectId: "rsogta-699a1",
            storageBucket: "rsogta-699a1.firebasestorage.app",
            messagingSenderId: "362406232758",
            appId: "1:362406232758:web:ccb3248055d592f01f1c17",
            measurementId: "G-CJ9R3TZSMS"
        };

        try {
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            // Candidate data
            const candidates = [
                { name: "Stan A", id: 1 },
                { name: "Stan B", id: 2 },
                { name: "Stan C", id: 3 },
                { name: "Stan D", id: 4 }
            ];

            // Populate candidate list
            const candidateList = document.getElementById('candidateList');
            candidates.forEach(candidate => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="vote" value="${candidate.id}" class="text-pink-500 focus:ring-pink-500">
                        <span class="text-gray-700">${candidate.name}</span>
                    </label>
                `;
                candidateList.appendChild(div);
            });

            // Handle authentication state
            const loginButton = document.getElementById('loginButton');
            const logoutButton = document.getElementById('logoutButton');
            const loginForm = document.getElementById('loginForm');
            const voteTallySection = document.getElementById('voteTallySection');
            onAuthStateChanged(auth, user => {
                if (user) {
                    loginButton.classList.add('hidden');
                    logoutButton.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                    voteTallySection.classList.remove('hidden');
                    updateVoteTally();
                } else {
                    loginButton.classList.remove('hidden');
                    logoutButton.classList.add('hidden');
                    loginForm.classList.add('hidden');
                    voteTallySection.classList.add('hidden');
                }
            });

            // Show login form when login button is clicked
            loginButton.addEventListener('click', () => {
                loginForm.classList.toggle('hidden');
            });

            // Handle login form submission
            document.getElementById('authForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    alert('Logged in successfully!');
                } catch (error) {
                    console.error('Login error:', error.message);
                    alert(`Login failed: ${error.message}`);
                }
            });

            // Handle logout
            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    alert('Logged out successfully!');
                } catch (error) {
                    console.error('Logout error:', error.message);
                    alert(`Error logging out: ${error.message}`);
                }
            });

            // Handle form submission for voting
            document.getElementById('voteForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const selectedVote = document.querySelector('input[name="vote"]:checked');
                if (selectedVote) {
                    const candidate = candidates.find(c => c.id == selectedVote.value);
                    try {
                        // Increment vote count in Firestore
                        const candidateRef = doc(db, 'votes', `candidate_${candidate.id}`);
                        await setDoc(candidateRef, {
                            name: candidate.name,
                            votes: increment(1)
                        }, { merge: true });
                        console.log(`Vote submitted for: ${candidate.name}`);
                        alert(`Thank you for voting for ${candidate.name}!`);
                        if (auth.currentUser) updateVoteTally(); // Refresh tally if admin is logged in
                    } catch (error) {
                        console.error('Error submitting vote:', error.message);
                        alert(`Error submitting vote: ${error.message}`);
                    }
                } else {
                    alert('Please select a stan to vote for!');
                }
            });

            // Function to update vote tally display
            async function updateVoteTally() {
                const voteTally = document.getElementById('voteTally');
                voteTally.innerHTML = ''; // Clear current tally
                try {
                    const snapshot = await getDocs(collection(db, 'votes'));
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const li = document.createElement('li');
                        li.textContent = `${data.name}: ${data.votes || 0} votes`;
                        voteTally.appendChild(li);
                    });
                } catch (error) {
                    console.error('Error fetching vote tally:', error.message);
                    voteTally.innerHTML = '<li>Error loading vote tally.</li>';
                }
            }
        } catch (error) {
            console.error('Firebase initialization error:', error.message);
            alert('Error initializing the application. Please check the console for details.');
        }
    </script>
</head>
<body class="bg-pink-100 font-sans">
    <header class="bg-pink-600 text-white text-center py-6">
        <h1 class="text-4xl font-bold">THE REAL STANS OF GTA</h1>
        <p class="text-lg mt-2">Vote for the Most Valuable Stan of the Week!</p>
        <div id="authSection" class="mt-4">
            <button id="loginButton" class="bg-white text-pink-600 py-1 px-4 rounded-lg hidden">Admin Login</button>
            <button id="logoutButton" class="bg-white text-pink-600 py-1 px-4 rounded-lg hidden">Logout</button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-6">
        <section id="loginForm" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold text-pink-700 mb-4">Admin Login</h2>
            <form id="authForm" class="space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full p-2 border rounded-lg">
                <input type="password" id="password" placeholder="Password" class="w-full p-2 border rounded-lg">
                <button type="submit" class="w-full bg-pink-500 text-white py-2 px-4 rounded-lg hover:bg-pink-700 transition">Login</button>
            </form>
        </section>

        <section class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-semibold text-pink-700 mb-4">Cast Your Vote</h2>
            <form id="voteForm" class="space-y-4">
                <div id="candidateList" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Candidate options will be populated by JavaScript -->
                </div>
                <button type="submit" class="w-full bg-pink-500 text-white py-2 px-4 rounded-lg hover:bg-pink-700 transition">Submit Vote</button>
            </form>
        </section>

        <section id="voteTallySection" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold text-pink-700 mb-4">Vote Tally (Admin Only)</h2>
            <ul id="voteTally" class="text-gray-700 space-y-2">
                <!-- Vote counts will be populated by JavaScript -->
            </ul>
        </section>

        <section class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-semibold text-pink-700 mb-4">About the Show</h2>
            <p class="text-gray-700">Welcome to <strong>THE REAL STANS OF GTA</strong>! Each week, our fabulous stans compete for the title of Most Valuable Stan. Your votes decide who shines the brightest in the streets of Los Santos. Stay tuned for weekly updates and cast your vote to support your favorite!</p>
        </section>
    </main>
</body>
</html>